{% assign main_menu_linklist = linklists[section.settings.menu].links %}

<div class="sticky top-0 z-40 bg-white shadow-sm" x-data="headerMenu()" x-init="init()">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-6">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a href="/" class="block w-32" aria-label="Homepage">
          {% render 'logo' %}
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-8">
        {% for link in main_menu_linklist %}
          {% if link.links != blank %}
            <div class="relative" @mouseleave="openMenu = null">
              <button
                @click="openMenu === '{{ link.handle }}' ? openMenu = null : openMenu = '{{ link.handle }}'"
                class="inline-flex items-center gap-1 text-gray-700 hover:text-black text-base"
              >
                {{ link.title }}
                {% render 'icon-dropdown' %}
              </button>

              <div
                x-show="openMenu === '{{ link.handle }}'"
                x-transition
                class="absolute left-0 mt-2 w-64 bg-white shadow-lg rounded-lg border z-40"
              >
                <div class="py-2">
                  {% for childlink in link.links %}
                    <a href="{{ childlink.url }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                      {{ childlink.title }}
                    </a>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% else %}
            <a href="{{ link.url }}" class="text-base text-gray-700 hover:text-black">
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Right Section (Cart + Account) -->
      <div class="hidden md:flex items-center space-x-4">
        {% render 'header-search' %}

        {%- if settings.cart_type == 'page' -%}
          <a href="{{ routes.cart_url }}" class="relative text-gray-700 hover:text-black">
            {% render 'icon-shopping-bag' %}
            {% if cart.item_count > 0 %}
              <span class="absolute -top-2 -right-2 text-xs text-white bg-red-500 rounded-full px-1">
                {{ cart.item_count }}
              </span>
            {% endif %}
          </a>
        {%- else -%}
          <!-- Alpine container для ініціалізації -->
          <div x-data @alpine-init.window="$store.cart.initCart()">
            <div class="relative">
               <!-- Кнопка для відкриття/закриття Drawer -->
              <button @click="$store.cart.openDrawer = true" class="relative text-gray-700 hover:text-black">
                {% render 'icon-shopping-bag' %}
                <span class="absolute -top-2 -right-2 text-xs text-white bg-red-500 rounded-full px-1" x-text="$store.cart.cartItemsCount"></span>
              </button>
              {% render 'minicart' %}
            </div>
          </div>

        {%- endif -%}

        {% if shop.customer_accounts_enabled %}
          {% if customer %}
            <a href="{{ routes.account_url }}" class="text-base text-gray-700 hover:text-black">Account</a>
            {{
              'Log out'
              | customer_logout_link
              | replace: '<a', '<a class="text-base text-gray-700 hover:text-black"'
            }}
          {% else %}
            {{
              'Log in'
              | customer_login_link
              | replace: '<a', '<a class="text-base text-gray-700 hover:text-black"'
            }}
            {{
              'Register'
              | customer_register_link
              | replace: '<a', '<a class="text-base text-gray-700 hover:text-black"'
            }}
          {% endif %}
        {% endif %}
      </div>

      <!-- Mobile Menu Button -->
      <div class="md:hidden">
        <button @click="mobileMenuOpen = true" class="text-gray-700 hover:text-black">
          {% render 'icon-menu' %}
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div x-show="mobileMenuOpen" x-transition class="fixed inset-0 z-50 bg-white overflow-y-auto md:hidden">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">{{ section.settings.mobile_menu_title }}</h2>
        <button @click="mobileMenuOpen = false" class="text-gray-700 hover:text-black">
          {% render 'icon-close' %}
        </button>
      </div>

      <nav class="space-y-4">
        {% for link in main_menu_linklist %}
          {% if link.links != blank %}
            <div x-data="{ open: false }">
              <button @click="open = !open" class="flex justify-between w-full text-left text-gray-700 hover:text-black">
                <span>{{ link.title }}</span>
                {% render 'icon-dropdown' %}
              </button>
              <div x-show="open" x-transition class="pl-4 mt-2 space-y-2">
                {% for childlink in link.links %}
                  <a href="{{ childlink.url }}" class="block text-gray-600 hover:text-black">
                    {{ childlink.title }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <a href="{{ link.url }}" class="block text-gray-700 hover:text-black">
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Mobile Cart & Account -->
      <div class="mt-6 space-y-2">
        {% if shop.customer_accounts_enabled %}
          {% if customer %}
            <a href="{{ routes.account_url }}" class="block text-gray-700 hover:text-black">Account</a>
            {{
              'Log out'
              | customer_logout_link
              | replace: '<a', '<a class="block text-gray-700 hover:text-black"'
            }}
          {% else %}
            {{
              'Log in'
              | customer_login_link
              | replace: '<a', '<a class="block text-gray-700 hover:text-black"'
            }}
            {{
              'Register'
              | customer_register_link
              | replace: '<a', '<a class="block text-gray-700 hover:text-black"'
            }}
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function headerMenu() {
    return {
      openMenu: null,
      mobileMenuOpen: false,
      init() {
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') this.mobileMenuOpen = false
        })
      }
    }
  }
</script>


{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "text",
      "id": "mobile_menu_title",
      "default": "Menu",
      "label": "Mobile Menu Title"
    },
    {
      "type": "link_list",
      "id": "menu",
      "default": "main-menu",
      "label": "Heading Navigation Menu"
    }
  ]
}
{% endschema %}
